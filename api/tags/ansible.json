{"name":"ansible","slug":"ansible","count":1,"posts":[{"title":"Ansible入门","slug":"ansible","date":"2019-10-03T10:40:27.000Z","updated":"2020-02-16T10:54:11.945Z","comments":true,"pin":null,"path":"api/articles/ansible.json","excerpt":"","keywords":null,"cover":null,"content":"<h2 id=\"ansible快速入门\">Ansible快速入门</h2>\n<ul>\n<li>\n<p><a href=\"https://docs.ansible.com/ansible/latest/index.html\" target=\"_blank\" rel=\"noopener\"> Ansible官方文档</a></p>\n</li>\n<li>\n<p><a href=\"https://ansible-tran.readthedocs.io/en/latest/docs/\" target=\"_blank\" rel=\"noopener\">Ansible中文指南</a></p>\n</li>\n</ul>\n<p><code>以下内容以kafka,zk部署为例</code></p>\n<h3 id=\"1inventory文件\">1.Inventory文件</h3>\n<p>Ansible 可同时操作属于一个组的多台主机,组和主机之间的关系通过 inventory 文件配置. 默认的文件路径为 /etc/ansible/hosts</p>\n<p>除了默认文件外，还可以同时使用多个inventory文件。</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[kafka-es-fraaws]</span><br><span class=\"line\">&lt;kafka ip 1&gt; ansible_ssh_host=&lt;kafka ip 1&gt; ansible_ssh_user=deploy broker_id=0</span><br><span class=\"line\">&lt;kafka ip 2&gt; ansible_ssh_host=&lt;kafka ip 2&gt; ansible_ssh_user=deploy broker_id=1</span><br><span class=\"line\">&lt;kafka ip 3&gt; ansible_ssh_host=&lt;kafka ip 3&gt; ansible_ssh_user=deploy broker_id=2</span><br><span class=\"line\"></span><br><span class=\"line\">[kafka-es-sfo]</span><br><span class=\"line\">&lt;kafka ip 4&gt; ansible_ssh_host=&lt;kafka ip 4&gt; ansible_ssh_user=deploy broker_id=0</span><br><span class=\"line\">&lt;kafka ip 5&gt; ansible_ssh_host=&lt;kafka ip 5&gt; ansible_ssh_user=deploy broker_id=1</span><br><span class=\"line\">&lt;kafka ip 6&gt; ansible_ssh_host=&lt;kafka ip 6&gt; ansible_ssh_user=deploy broker_id=2</span><br><span class=\"line\"></span><br><span class=\"line\">[kafka-es-sin]</span><br><span class=\"line\">&lt;kafka ip 7&gt; ansible_ssh_host=&lt;kafka ip 7&gt; ansible_ssh_user=deploy broker_id=0</span><br><span class=\"line\">&lt;kafka ip 8&gt; ansible_ssh_host=&lt;kafka ip 8&gt; ansible_ssh_user=deploy broker_id=1</span><br><span class=\"line\">&lt;kafka ip 9&gt; ansible_ssh_host=&lt;kafka ip 9&gt; ansible_ssh_user=deploy broker_id=2</span><br><span class=\"line\"></span><br><span class=\"line\">[kafka-test]</span><br><span class=\"line\">&lt;kafka ip 10&gt; ansible_ssh_host=&lt;kafka ip 10&gt; ansible_ssh_user=deploy broker_id=0</span><br><span class=\"line\">&lt;kafka ip 11&gt; ansible_ssh_host=&lt;kafka ip 11&gt; ansible_ssh_user=deploy broker_id=1</span><br></pre></td></tr></table></figure></div>\n<ul>\n<li>主机与组：[]内代表组名，用于对主机进行分类；</li>\n<li>ansible_ssh_host：有时我们想为主机起一个别名，而不是使用上面所示的ip，这时需要使用ansible_ssh_host指定别名所代表的ip；</li>\n<li>ansible_ssh_user：指定连接到目标host的哪个用户；</li>\n<li>主机变量： 给主机分配变量，如上例，为每一个主机分配broker_id，为了在配置文件中使用。</li>\n</ul>\n<p><code>其它Inventory相关知识可以前往官方文档或中文指南学习</code></p>\n<h3 id=\"2-ansible命令管理主机\">2. Ansible命令管理主机</h3>\n<p>ansible提供命令行工具，官方起名为Ad-Hoc Commands，命令的格式是：</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible &lt;host-patterns&gt; [options]</span><br></pre></td></tr></table></figure></div>\n<p>常用的是检查所有远程主机环境是否可以被ansible主机访问：</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible all -m ping</span><br></pre></td></tr></table></figure></div>\n<p>这里的all代表<code>目标为仓库(inventory)中的所有机器</code></p>\n<p>Patterns参考链接： <a href=\"https://ansible-tran.readthedocs.io/en/latest/docs/intro_patterns.html\" target=\"_blank\" rel=\"noopener\">https://ansible-tran.readthedocs.io/en/latest/docs/intro_patterns.html</a></p>\n<p>其他命令模块参考链接： <a href=\"https://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html\" target=\"_blank\" rel=\"noopener\">https://ansible-tran.readthedocs.io/en/latest/docs/intro_adhoc.html</a></p>\n<h3 id=\"3-playbook\">3. Playbook</h3>\n<p>Playbooks 是 Ansible 的配置,部署,编排语言.他们可以被描述为一个需要希望远程主机执行命令的方案,或者一组IT程序运行的命令集合。在基础层面, playbooks 可以被用来管理用于部署到远程主机的配置文件。</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> ── roles</span><br><span class=\"line\">|    ├──jdk</span><br><span class=\"line\">|    ├── kafka</span><br><span class=\"line\">|    |    ├── files</span><br><span class=\"line\">|    |    ├── handlers</span><br><span class=\"line\">|    |    ├── tasks</span><br><span class=\"line\">|    |    └── templates</span><br><span class=\"line\">|    ├── zk</span><br><span class=\"line\">|    └── es</span><br><span class=\"line\">└── kafka-2.3.0.yml</span><br></pre></td></tr></table></figure></div>\n<p>playbook的简单目录结构如上图所示，yml中指定任务的name，roles,和变量。而在部署任务中，一般每个role都代表一个部署的应用或工具，其中包含了tasks任务列表，一个task会在其对应所有主机上执行完毕之后，下一个task才会执行，每个task的目标在于执行一个module。</p>\n<h3 id=\"定义variable变量\">定义Variable（变量）</h3>\n<p><code>变量可以用来处理配置文件在每个节点中的个体差异和系统间的不同，以下介绍几种定义变量的形式</code></p>\n<p>（1）inventory定义变量</p>\n<p>在inventory文件中，每一个Host可以定义自己的变量，如上述Kakfa集群中每个节点的broker_id</p>\n<p>（2）在playbook中定义变量</p>\n<p>在playbook yml中可以定义变量，如：</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- hosts: webservers</span><br><span class=\"line\">  vars:</span><br><span class=\"line\">    http_port: 80</span><br></pre></td></tr></table></figure></div>\n<p>（3）在文件和role中定义变量（TODO）</p>\n<p>（4）Facts变量</p>\n<p>Facts变量是自动发现的而不是用户自己设置的，通过访问远程系统获取响应信息。</p>\n<p>比如获取当前主机的ip地址：<code></code></p>\n<p>（5）魔法变量</p>\n<p>ansible会自动提供一些变量，无需定义，这些变量中重要的有<code>hostvars</code>，<code>group_names</code>，<code>groups</code></p>\n<p>其中hostvars可以让我们访问其他主机的变量，group_names是当前主机所在所有群组的列表，groups是inventory中所有群组的列表，可以用于枚举群组中的所有主机，例如：</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% for host in groups[&apos;app_servers&apos;] %&#125;</span><br><span class=\"line\">   # something that applies to all app servers.</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></div>\n<p><code>在zookeeper的部署中zoo.cfg配置文件需要用到魔法变量</code></p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"PLAIN\"><figure class=\"iseeu highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% for host in groups[group_names[0]] %&#125;</span><br><span class=\"line\">server.&#123;&#123; hostvars[host][&apos;myid&apos;]&#125;&#125;=&#123;&#123;hostvars[host][&quot;ansible_eth0&quot;][&quot;ipv4&quot;][&quot;address&quot;]&#125;&#125;:2888:3888</span><br><span class=\"line\">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure></div>\n<h3 id=\"roles\">Roles</h3>\n<p>每个组件或应用的部署可以整合成一个role，如jdk,kafka,zookeeper,es，在playbook yml中选定role去执行task</p>\n<h3 id=\"module\">Module</h3>\n<p>官方文档</p>\n<p><a href=\"https://docs.ansible.com/ansible/latest/modules/modules_by_category.html\" target=\"_blank\" rel=\"noopener\">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></p>\n<p>常用模块如ping,yum,template,copu,file,unarchive,command,shell</p>\n<p>可参考博客：</p>\n<p><a href=\"https://blog.csdn.net/pushiqiang/article/details/78249665\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/pushiqiang/article/details/78249665</a></p>\n<p><a href=\"http://www.yfshare.vip/2017/04/05/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/\" target=\"_blank\" rel=\"noopener\">http://www.yfshare.vip/2017/04/05/Ansible常用模块/</a></p>\n","text":"Ansible快速入门 Ansible官方文档Ansible中文指南以下内容以kafka,zk部署为例1.Inventory文件Ansible 可同时操作属于一个组的多台主机,组和主机之间的关系通过 inventory 文件配置. 默认的文件路径为 /etc/ansible/ho","link":"","raw":null,"photos":[],"categories":[],"tags":[{"name":"ansible","slug":"ansible","count":1,"path":"api/tags/ansible.json"}]}]}