{"title":"记一次kafka故障","slug":"kafka-problem","date":"2019-10-15T05:55:16.000Z","updated":"2020-02-16T07:56:34.614Z","comments":true,"path":"api/articles/kafka-problem.json","photos":[],"link":"","excerpt":"","covers":null,"keywords":"","content":"<h3 id=\"故障描述\">故障描述</h3>\n<blockquote>\n<p>Kafka节点9092端口健康监测突然red，并且反复重启无效。</p>\n</blockquote>\n<h3 id=\"问题分析\">问题分析</h3>\n<blockquote>\n<p>该kafka集群，由若干个用户同时<code>直接</code>进行数据写入，导致client数目非常巨大，tcp connection数量一直维持high level (60k - 70k) ；</p>\n<p>大并发量下，open file（文件句柄）过多，导致节点刚起来的时候直接打爆ulimit默认限制。</p>\n</blockquote>\n<h3 id=\"解决方案\">解决方案</h3>\n<h4 id=\"方案1iptables批量放开连接让连接慢慢分摊到别的节点上\">方案1：iptables批量放开连接，让连接慢慢分摊到别的节点上</h4>\n<p>(1) 通过iptables和ipset限制端口访问量</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># !/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">yum -y install ipset</span><br><span class=\"line\"></span><br><span class=\"line\">ipset create nodes <span class=\"built_in\">hash</span>:ip </span><br><span class=\"line\"></span><br><span class=\"line\">netstat -anp|grep xx.xx.xxx.xx:9092 |awk &#123;<span class=\"string\">'print $5'</span>&#125;|head -10000|sort -n| uniq |cut -f4 -d<span class=\"string\">\":\"</span> &gt; kafka-ip.txt</span><br><span class=\"line\"></span><br><span class=\"line\">cat kafka-ipv4.txt | <span class=\"keyword\">while</span> <span class=\"built_in\">read</span> line</span><br><span class=\"line\"><span class=\"keyword\">do</span> </span><br><span class=\"line\">\tipset add nodes <span class=\"variable\">$line</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -I INPUT -m <span class=\"built_in\">set</span> --match-set nodes src -p tcp --destination-port 9092 -j DROP</span><br><span class=\"line\">service iptables save</span><br></pre></td></tr></table></figure></div>\n<p>(2) supervisord启动kafka</p>\n<p><code>supervisorctl restart kafka</code></p>\n<p>(3) ipset remove ip</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># !/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 2 2000 10000`</span><br><span class=\"line\"><span class=\"keyword\">do</span> </span><br><span class=\"line\">\tstart=<span class=\"variable\">$i</span></span><br><span class=\"line\">\tend=`expr <span class=\"variable\">$i</span>+2000`</span><br><span class=\"line\">  sed -n <span class=\"string\">'/$start,$end/p'</span> kafka-ip.txt | <span class=\"keyword\">while</span> <span class=\"built_in\">read</span> line </span><br><span class=\"line\">  <span class=\"keyword\">do</span></span><br><span class=\"line\">    ipset del nodes <span class=\"variable\">$line</span></span><br><span class=\"line\">  <span class=\"keyword\">done</span></span><br><span class=\"line\">  sleep 2m</span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">service iptables save</span><br><span class=\"line\">service iptables restart</span><br></pre></td></tr></table></figure></div>\n<p>(3) 关闭防火墙</p>\n<p><code>service iptables stop</code><br>\n此时节点已恢复.</p>\n<h4 id=\"方案2修改ulimit限制\">方案2：修改ulimit限制</h4>\n<p>第一种：临时修改正在运行的进程的限制</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># centos 6 版本的机器</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> -n <span class=\"string\">'Max open files=1048576:1048576'</span> &gt; /proc/&lt;PID&gt;/limits</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># centos 7 版本的机器</span></span><br><span class=\"line\">$ prlimit --nofile=1048576:1048576 --pid 130328</span><br></pre></td></tr></table></figure></div>\n<blockquote>\n<p>缺陷是一旦进程再一次挂掉，重新起来的时候max open file依然是默认值。</p>\n</blockquote>\n<p>第二种：修改系统配置，重启supervisor和kafka后永久生效</p>\n<div class=\"highlight-wrap\"autocomplete=\"off\" autocorrect=\"off\" autocapitalize=\"off\" spellcheck=\"false\" contenteditable=\"true\"data-rel=\"BASH\"><figure class=\"iseeu highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改 /etc/security/limits.conf</span><br><span class=\"line\">增加 * - nofile 1048576(最大文件句柄数量) 这行</span><br><span class=\"line\"></span><br><span class=\"line\">修改 /etc/security/limits.d/90-nproc.conf 或者 /etc/security/limits.d/20-nproc.conf</span><br><span class=\"line\">增加 * - nofile 1048576(最大文件句柄数量) 这行</span><br></pre></td></tr></table></figure></div>\n","categories":[],"tags":[{"name":"kafka","slug":"kafka","count":1,"path":"api/tags/kafka.json"}]}